name: CI
on:
  pull_request:
  push:
    branches:
      - master

jobs:
  replace-pr-number:
    name: Replace PR number in a message
    runs-on: ubuntu-latest
    if: ${{ github.ref != 'refs/heads/master' }}
    steps:
      - name: Replace Pull Request Body
        uses: ivangabriele/find-and-replace-pull-request-body@v1.1.5
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          find: "{{PR_NUMBER}}"
          replace: ${{ github.event.pull_request.number }}

  prettier:
    name: Prettier
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-env
      - name: Run code formatting verification
        run: npm run format:verify

  typecheck:
    name: Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-env
      - name: Run typecheck
        run: yarn typecheck

  linter:
    name: Linter
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-env
      - name: Run linter
        run: yarn lint
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-env
      - name: Build web app
        run: yarn web:build
        env:
          NODE_ENV: test
          S3_BUCKET: test-bucket
          S3_ENDPOINT: https://fake-endpoint.org
          ANALYZE_BUNDLE: true
      - name: Upload web build dir
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: |
            apps/web/.next
            !apps/web/.next/cache/**
            !apps/web/.next/analyze/**
            !*.map
          retention-days: 0
          include-hidden-files: true
          if-no-files-found: error
      - name: Upload bundle analyzer results
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analyzer
          path: apps/web/.next/analyze
          if-no-files-found: error
          include-hidden-files: true

  backend-test:
    name: Backend tests
    runs-on: ubuntu-latest
    outputs:
      coverage: ${{ steps.coverage-percent.outputs.coverage }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-env
      - name: Run backend tests
        run: yarn backend:test
      - name: Archive code coverage results
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: testing/vitest/coverage
          if-no-files-found: error
      - name: Report coverage
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          name: backend
          working-directory: testing/vitest
          vite-config-path: ../../vitest.config.ts
      - name: Pass coverage percent to output
        id: coverage-percent
        run: |
          COVERAGE=$(node -e 'console.log(Object.entries(require("./testing/vitest/coverage/coverage-summary.json").total).reduce((acc, [, m]) => Math.min(acc, m.pct), 100))')
          echo "Coverage is $COVERAGE"
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

  frontend-test:
    name: Frontend tests
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3, 4]
        shardTotal: [4]
    container:
      image: mcr.microsoft.com/playwright:v1.46.0-jammy
    outputs:
      coverage: ${{ steps.coverage-percent.outputs.coverage }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-env
      - name: Fetch web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: apps/web/.next
      - name: Run frontend tests
        id: tests
        # see https://github.com/microsoft/playwright/issues/6500
        run: HOME=/root yarn frontend:test --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}
      - name: Upload Playwright report chunks
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: blob-report-${{ matrix.shardIndex }}
          path: testing/playwright/blob-report
          retention-days: 1

  merge-reports:
    name: Merge Playwright reports
    if: ${{ !cancelled() }}
    needs: frontend-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-env
      - name: Download blob reports from GitHub Actions Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-blob-reports
          pattern: blob-report-*
          merge-multiple: true
      - name: Merge into HTML Report
        run: npx playwright merge-reports --reporter html ./all-blob-reports
      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: html-report-attempt-${{ github.run_attempt }}
          path: playwright-report
          retention-days: 30
          if-no-files-found: error

  update-badges:
    name: Badges
    runs-on: ubuntu-latest
    needs: backend-test
    steps:
      - name: Backend coverage badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        env:
          branch: ${{ github.ref == 'refs/heads/master' && 'master' || github.event.pull_request.number }}
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: 878178ea4ba8d28122cc72204df909e7
          filename: backend_coverage_${{ env.branch }}.json
          label: Backend coverage
          message: ${{ needs.backend-test.outputs.coverage }}%
          valColorRange: ${{ needs.backend-test.outputs.coverage }}
          minColorRange: 50
          maxColorRange: 100

  analyze:
    name: Analyze bundle
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-env
      - name: Fetch web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: apps/web/.next
      - name: Analyze bundle sizes
        uses: transferwise/actions-next-bundle-analyzer@master
        with:
          # Filename of the workflow this step is defined in
          workflow-id: continuous-integration-workflow.yml
          working-directory: /apps/web
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
